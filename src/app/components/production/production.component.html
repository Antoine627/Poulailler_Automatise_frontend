<div class="app-container">
  <!-- Main Content -->
  <div class="main-content">
    <div class="dashboard-management-container">
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <div class="spinner"></div>
        <p>Chargement des données...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error" class="error-state">
        <p>{{ error }}</p>
        <button class="btn primary" (click)="loadDashboardData()">Réessayer</button>
      </div>

      <!-- Dashboard Content -->
      <div *ngIf="!loading && !error" class="dashboard-content">
        <!-- Header Section -->
        <h1>Gestion Production</h1>

        <!-- Summary Cards - Horizontal -->
        <div class="summary-cards">
          <!-- Production Totale -->
          <div class="card">
            <div class="card-header">
              <h3>Production Totale</h3>
            </div>
            <div class="card-content">
              <p class="number">{{ productionStats?.totalProduction || 0 }}</p>
              <p class="subtitle">Mortalité: {{ productionStats?.totalMortality || 0 }}</p>
              <p>Mortalité totale : {{ productionManagement.deaths | number:'1.0-0' }}</p>
            </div>
          </div>

          <!-- Coûts Totaux -->
          <div class="card">
            <div class="card-header">
              <h3>Coûts Totaux</h3>
              <p *ngIf="feedCalculation.totalBagsNeeded">Nombre total de sacs nécessaires : {{ feedCalculation.totalBagsNeeded | number:'1.0-0' }}</p>
            </div>
            <div class="card-content">
              <p class="number">{{ feedCalculation.totalCostFCFA || totalCosts?.total || 0 }} FCFA</p>
            </div>
          </div>

          <!-- Rentabilité -->
          <div class="card">
            <div class="card-header">
              <h3>Rentabilité</h3>
            </div>
            <div class="card-content">
              <p class="number" [ngClass]="profitabilityCalculation.profit > 0 ? 'positive' : 'negative'">
                {{ profitabilityCalculation.profit || 0 | number:'1.0-0' }} FCFA
              </p>
            </div>
          </div>

          <!-- Résultat -->
          <div class="card">
            <div class="card-header">
              <h3>Résultat</h3>
              <p>Coût Total : {{ totalFeedCost + totalChickCost + totalOtherCosts | number:'1.0-0' }} FCFA</p>
             
            </div>
            <div class="card-content">
              <p class="subtitle">
                {{ (profitabilityCalculation.profit || 0) > 0 ? 'Bénéfice' : 'Perte' }}
              </p>
            </div>
          </div> 
        </div>

        <!-- Vertical Sections -->
        <div class="vertical-sections">
          <!-- Production Section -->
          <div class="card production-card">
            <div class="card-header">
              <h2>Productions</h2>
            </div>
            <div class="card-content">
              <!--  -->
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Volailles</th>
                    <th>Mortalité</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let prod of paginatedProductions">
                    <td>{{ prod.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
                    <td>{{ prod.chickenCount }}</td>
                    <td>{{ prod.mortality }}</td>
                    <td class="actions">
                      <div class="action-buttons">
                        <!-- <button class="btn accent" (click)="editProduction(prod)">
                          <i class="fas fa-edit"></i>
                        </button> -->
                        <button class="btn danger" (click)="deleteProduction(prod)">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  <tr *ngIf="paginatedProductions.length === 0">
                    <td colspan="4" class="no-data">Aucune production enregistrée</td>
                  </tr>
                </tbody>
              </table>

              <!-- Pagination -->
              <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center">
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <a class="page-link" (click)="changePage(currentPage - 1)" tabindex="-1">Précédent</a>
                  </li>
                  <li class="page-item" *ngFor="let page of pageNumbers">
                    <a class="page-link" [class.active]="page === currentPage" (click)="changePage(page)">{{ page }}</a>
                  </li>
                  <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <a class="page-link" (click)="changePage(currentPage + 1)">Suivant</a>
                  </li>
                </ul>
              </nav>
            </div>
            
          </div>

          <!-- Feed Calculation Section -->
          <div class="card calculation-card">
            <div class="card-header">
              <h2>Calcul des Besoins en Alimentation</h2>
            </div>
            <div class="card-content">
              <form (ngSubmit)="calculateFeedRequirements()">
                
                <div class="form-group">
                  <label for="chickenCount">Nombre de Volailles</label>
                  <input
                    type="number"
                    id="chickenCount"
                    [(ngModel)]="feedCalculation.chickenCount"
                    (ngModelChange)="onChickenCountChange($event)"
                    name="chickenCount"
                    required
                    (keydown)="preventNegative($event)"
                  />
                </div>
               
                <!-- </div> -->
                <!-- <div class="form-group">
                  <label for="numberOfWeeks">Nombre de Semaines</label>
                  <input
                    type="number"
                    id="numberOfWeeks"
                    [(ngModel)]="feedCalculation.numberOfWeeks"
                    name="numberOfWeeks"
                    required
                    min="4"
                    max="10"
                  />
                  <div *ngIf="(feedCalculation.numberOfWeeks < 4 || feedCalculation.numberOfWeeks > 10) && feedCalculation.numberOfWeeks > 0" class="error">
                    <h4>Le nombre de semaines doit être compris entre 4 et 10.</h4>
                  </div>
                </div> -->
                <div class="form-group">
                  <label for="numberOfWeeks">Nombre de Semaines</label>
                  <input
                      type="number"
                      id="numberOfWeeks"
                      [(ngModel)]="feedCalculation.numberOfWeeks"
                      name="numberOfWeeks"
                      required
                      min="4"
                      max="10"
                  />
                  <div *ngIf="(feedCalculation.numberOfWeeks < 4 || feedCalculation.numberOfWeeks > 10) && feedCalculation.numberOfWeeks > 0" class="error">
                      <h4>Le nombre de semaines doit être compris entre 4 et 10.</h4>
                  </div>
              </div>
                <div class="form-group">
                  <label for="demarragePrice">Prix Démarrage (FCFA)</label>
                  <input
                    type="number"
                    id="demarragePrice"
                    [(ngModel)]="feedPrices['demarrage']"
                    name="demarragePrice"
                    required
                    (keydown)="preventNegative($event)"
                  />
                </div>
                <div class="form-group">
                  <label for="croissancePrice">Prix Croissance (FCFA)</label>
                  <input
                    type="number"
                    id="croissancePrice"
                    [(ngModel)]="feedPrices['croissance']"
                    name="croissancePrice"
                    required
                    (keydown)="preventNegative($event)"
                  />
                </div>
               
                <div class="form-group">
                  <label for="finitionPrice">Prix Finition (FCFA)</label>
                  <input
                      type="number"
                      id="finitionPrice"
                      [(ngModel)]="feedPrices['finition']"
                      name="finitionPrice"
                      required
                      (keydown)="preventNegative($event)"
                      [disabled]="feedCalculation.numberOfWeeks < 9"  
                  />
              </div>
               <!--  <button type="submit" class="btn primary">Calculer</button> -->

               <button type="submit" class="btn primary" 
               [disabled]="!feedCalculation.chickenCount || !feedCalculation.numberOfWeeks || !feedPrices['demarrage'] || !feedPrices['croissance'] || !feedPrices['finition']">
         Calculer
       </button>
              </form>
              <!-- Affichage amélioré des résultats de calcul d'alimentation -->
              <div *ngIf="showResults" class="result animate-fade">
                <h3>Résultats du calcul d'alimentation</h3>
                <!-- Informations générales -->
                <div class="result-summary">
                  <div class="result-item">
                    <span class="label">Nombre total de volailles:</span>
                    <span class="value">{{ feedCalculation.chickenCount }}</span>
                  </div>
                  <div class="result-item">
                    <span class="label">Durée d'élevage:</span>
                    <span class="value">{{ feedCalculation.numberOfWeeks }} semaines</span>
                  </div>
                  <div class="result-item">
                    <span class="label">Mortalité estimée:</span>
                    <span class="value">{{ feedCalculation.estimatedMortality || 0 }} ({{ ((feedCalculation.estimatedMortality || 0) / feedCalculation.chickenCount * 100) | number:'1.1-1' }}%)</span>
                  </div>
                  <div class="result-item">
                    <span class="label">Volailles restantes:</span>
                    <span class="value">{{ feedCalculation.survivingChickens || feedCalculation.chickenCount }}</span>
                  </div>
                </div>
                <!-- Tableau récapitulatif -->
                <table class="result-table">
                  <thead>
                    <tr>
                      <th>Phase</th>
                      <th>Alimentation (kg)</th>
                      <th>Sacs nécessaires</th>
                      <th>Coût (FCFA)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>Démarrage</strong></td>
                      <td>{{ feedCalculation.result.demarrage.totalFeedConsumptionKg | number:'1.2-2' }}</td>
                      <td>{{ feedCalculation.result.demarrage.bagsNeeded | number:'1.0-0' }}</td>
                      <td>{{ feedCalculation.result.demarrage.totalCostFCFA | number:'1.0-0' }}</td>
                    </tr>
                    <tr>
                      <td><strong>Croissance</strong></td>
                      <td>{{ feedCalculation.result.croissance.totalFeedConsumptionKg | number:'1.2-2' }}</td>
                      <td>{{ feedCalculation.result.croissance.bagsNeeded | number:'1.0-0' }}</td>
                      <td>{{ feedCalculation.result.croissance.totalCostFCFA | number:'1.0-0' }}</td>
                    </tr>
                    <tr>
                      <td><strong>Finition</strong></td>
                      <td>{{ feedCalculation.result.finition.totalFeedConsumptionKg | number:'1.2-2' }}</td>
                      <td>{{ feedCalculation.result.finition.bagsNeeded | number:'1.0-0' }}</td>
                      <td>{{ feedCalculation.result.finition.totalCostFCFA | number:'1.0-0' }}</td>
                    </tr>
                    <tr class="total-row">
                      <td><strong>TOTAL</strong></td>
                      <td><strong>{{ feedCalculation.totalFeedConsumptionKg | number:'1.2-2' }}</strong></td>
                      <td><strong>{{ feedCalculation.totalBagsNeeded | number:'1.0-0' }}</strong></td>
                      <td><strong>{{ feedCalculation.totalCostFCFA | number:'1.0-0' }}</strong></td>
                    </tr>
                  </tbody>
                </table>
                <!-- Coût par poulet -->
                <div class="cost-per-chicken">
                  <p><strong>Coût d'alimentation par poulet:</strong> {{ feedCalculation.totalCostFCFA / (feedCalculation.survivingChickens || feedCalculation.chickenCount) | number:'1.0-0' }} FCFA</p>
                </div>
                <div class="result-actions">
                  <!-- <button class="btn secondary" (click)="exportResultsToCSV()">Exporter les résultats</button> -->
                  <button class="btn primary" (click)="showResults = false">Fermer</button>
                </div>
              </div>
            </div>
          </div>

         

          <!-- Nouvelle section de calcul de rentabilité -->
          <div class="card calculation-card">
            <div class="card-header">
              <h2>Calcul de la Rentabilité</h2>
            </div>
            <div class="card-content">
             <!--  -->
             <!--  -->
              
             <form (ngSubmit)="calculateProfitability()" class="profitability-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="numberOfChickens">Nombre de Volailles</label>
                  <input
                    type="number"
                    id="numberOfChickens"
                    [(ngModel)]="profitabilityParams.numberOfChickens"
                    name="numberOfChickens"
                    required
                    readonly 
                    (keydown)="preventNegative($event)"
                  />
                </div>
            
                <div class="form-group">
                  <label for="chickPrice">Prix d'Achat Unitaire (FCFA)</label>
                  <input
                    type="number"
                    id="chickPrice"
                    [(ngModel)]="profitabilityParams.chickPrice"
                    name="chickPrice"
                    step="1"
                    required
                    (keydown)="preventNegative($event)"
                    (ngModelChange)="calculateTotalCosts()"  
                  />
                </div>
              </div>
            
              <div class="form-row">
                <div class="form-group">
                  <label for="feedCost">Coût Alimentation (FCFA)</label>
                  <input
                    type="number"
                    id="feedCost"
                    [(ngModel)]="profitabilityParams.feedCost"
                    name="feedCost"
                    required
                    (keydown)="preventNegative($event)"
                    readonly
                    (ngModelChange)="calculateTotalCosts()"
                  />
                </div>
            
                <div class="form-group">
                  <label for="otherCosts">Autres Frais (FCFA)</label>
                  <input
                    type="number"
                    id="otherCosts"
                    [(ngModel)]="profitabilityParams.otherCosts"
                    name="otherCosts"
                    required
                    (keydown)="preventNegative($event)"
                    (ngModelChange)="calculateTotalCosts()" 
                  />
                </div>
              </div>
            
              <!-- Résumé des Coûts -->
              <div class="cost-summary" *ngIf="profitabilityParams.chickPrice > 0 && profitabilityParams.feedCost > 0 && profitabilityParams.otherCosts > 0">
                <h3>Résumé des Coûts</h3>
                <p>Coût Total d'Alimentation : {{ totalFeedCost | number:'1.0-0' }} FCFA</p>
                <p>Coût Total des Poussins : {{ totalChickCost | number:'1.0-0' }} FCFA</p>
                <p>Frais Divers : {{ totalOtherCosts | number:'1.0-0' }} FCFA</p>
                <p>Coût Total : {{ totalFeedCost + totalChickCost + totalOtherCosts | number:'1.0-0' }} FCFA</p>
              </div>
            
              <!-- Tableau dynamique pour les ventes -->
              <!-- <div class="form-group">
                <label>Ventes</label>
                <div class="sales-table">
                  <div class="sales-row" *ngFor="let sale of profitabilityParams.sales; let i = index">
                    <div class="form-group">
                      <label>Nombre de Volailles</label>
                      <input
                        type="number"
                        [(ngModel)]="sale.quantity"
                        [name]="'saleQuantity' + i"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label>Prix de Vente Unitaire (FCFA)</label>
                      <input
                        type="number"
                        [(ngModel)]="sale.unitPrice"
                        [name]="'saleUnitPrice' + i"
                        required
                        (keydown)="preventNegative($event)"
                      />
                    </div>
                    <button class="btn danger" (click)="removeSale(i)" *ngIf="profitabilityParams.sales.length > 1">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                  <button class="btn secondary" (click)="addSale()">
                    <i class="fas fa-plus"></i> Ajouter une vente
                  </button>
                </div>
              </div> -->
              <!-- Tableau dynamique pour les ventes -->
                 <!-- Tableau dynamique pour les ventes -->
<div class="form-group">
  <label>Ventes</label>
  <div class="sales-table">
    <div class="sales-row" *ngFor="let sale of profitabilityParams.sales; let i = index" class="sales-row-container">
      <div class="form-group">
        <label>Nombre de Volailles</label>
        <input
          type="number"
          [(ngModel)]="sale.quantity"
          [name]="'saleQuantity' + i"
          required
        />
      </div>
      <div class="form-group">
        <label>Prix de Vente Unitaire (FCFA)</label>
        <input
          type="number"
          [(ngModel)]="sale.unitPrice"
          [name]="'saleUnitPrice' + i"
          required
          (keydown)="preventNegative($event)"
        />
      </div>
      <button class="btn danger" (click)="removeSale(i)" *ngIf="profitabilityParams.sales.length > 1">
        <i class="fas fa-trash"></i>
      </button>
    </div>
    <button class="btn secondary" (click)="addSale()">
      <i class="fas fa-plus"></i> Ajouter une vente
    </button>
  </div>
</div>
            
              <button type="submit" class="btn primary">Calculer</button>
            </form>
              <!-- Résultats du calcul de rentabilité -->
              <div *ngIf="profitabilityResults" class="result animate-fade">
                <h3>Résultat du calcul de rentabilité</h3>
                
                <!-- Récapitulatif -->
                <div class="profitability-summary">
                  <div class="profit-indicator" [ngClass]="profitabilityResults.profit > 0 ? 'positive' : 'negative'">
                    <span class="status">{{ profitabilityResults.profit > 0 ? 'Bénéfice' : 'Perte' }}</span>
                    <span class="amount">{{ profitabilityResults.profit | number:'1.0-0' }} FCFA</span>
                  </div>
                </div>
                
                <!-- Détails des calculs -->
                <table class="result-table">
                  <tr>
                    <td>Nombre de volailles</td>
                    <td>{{ profitabilityResults.numberOfChickens }}</td>
                  </tr>
                  <tr>
                    <td>Prix d'achat total</td>
                    <td>{{ profitabilityResults.purchaseCost | number:'1.0-0' }} FCFA</td>
                  </tr>
                  <tr>
                    <td>Frais d'alimentation</td>
                    <td>{{ profitabilityResults.feedCost | number:'1.0-0' }} FCFA</td>
                  </tr>
                  <tr>
                    <td>Autres frais</td>
                    <td>{{ profitabilityResults.otherCosts | number:'1.0-0' }} FCFA</td>
                  </tr>
                  <tr class="total-row">
                    <td><strong>Coût total (Prix de revient)</strong></td>
                    <td><strong>{{ profitabilityResults.totalCost | number:'1.0-0' }} FCFA</strong></td>
                  </tr>
                  <tr>
                    <td>Prix de revient unitaire</td>
                    <td>{{ profitabilityResults.costPerUnit | number:'1.0-0' }} FCFA</td>
                  </tr>
                  <tr>
                    <td>Revenu total estimé</td>
                    <td>{{ profitabilityResults.totalRevenue | number:'1.0-0' }} FCFA</td>
                  </tr>
                  <tr class="result-row">
                    <td><strong>{{ profitabilityResults.profit > 0 ? 'Bénéfice' : 'Perte' }}</strong></td>
                    <td><strong>{{ profitabilityResults.profit | number:'1.0-0' }} FCFA</strong></td>
                  </tr>
                  <tr>
                    <td>{{ profitabilityResults.profit > 0 ? 'Bénéfice' : 'Perte' }} par volaille</td>
                    <td>{{ profitabilityResults.profitPerUnit | number:'1.0-0' }} FCFA</td>
                  </tr>
                </table>
                
                <div class="result-actions">
                  <!-- <button class="btn secondary" (click)="exportProfitabilityToCSV()">Exporter les résultats</button> -->
                  <button class="btn primary" (click)="profitabilityResults = null">Fermer</button>
                </div>
              </div>
            </div>
          </div>

          <!--  -->
          <div class="card calculation-card">
            <div class="card-header">
                <h2>Gestion de la Production</h2>
            </div>
            <div class="card-content">
                <form (ngSubmit)="isAdding ? addProduction() : updateProduction()" #productionForm="ngForm">
                    <div class="form-group">
                        <label for="totalProduction">Production Totale</label>
                        <input
                            type="number"
                            id="totalProduction"
                            [(ngModel)]="productionManagement.totalProduction"
                            name="totalProduction"
                            required
                            (keydown)="preventNegative($event)"
                        />
                    </div>
                    <div class="form-group">
                        <label for="deaths">Nombre de Décès</label>
                        <input
                            type="number"
                            id="deaths"
                            [(ngModel)]="productionManagement.deaths"
                            name="deaths"
                            required
                            [max]="productionManagement.totalProduction" 
                        />
                        <div *ngIf="productionManagement.deaths > productionManagement.totalProduction" class="error">
                            <h4>Le nombre de décès ne peut pas dépasser le nombre total de volailles.</h4>
                        </div>
                    </div>
                    <button type="submit" class="btn primary" 
                            [disabled]="productionManagement.deaths > productionManagement.totalProduction || productionManagement.totalProduction < 0 || productionManagement.deaths < 0">
                        {{ isAdding ? 'Ajouter' : 'Modifier' }}
                    </button>
                </form>
                <div *ngIf="productionManagement.updatedProduction !== undefined" class="result">
                    <h3>Résultat</h3>
                    <p>Production actuelle : {{ productionManagement.updatedProduction | number:'1.0-0' }}</p>
                    <p>Mortalité totale : {{ productionManagement.deaths | number:'1.0-0' }}</p>
                </div>
            </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div>
  <h3>Rentabilité</h3>
  <p>Revenus Totaux : {{ profitabilityCalculation.totalRevenue | number:'1.0-0' }} FCFA</p>
  <p>Coûts Totaux : {{ profitabilityCalculation.totalCosts | number:'1.0-0' }} FCFA</p>
  <p>Profit : {{ profitabilityCalculation.profit | number:'1.0-0' }} FCFA</p>
  <p>Marge Bénéficiaire : {{ profitabilityCalculation.profitMargin | number:'1.0-2' }} %</p>
</div>








<!-- Notification Bar -->
<div *ngIf="showNotificationBar" 
     class="notification-bar" 
     [ngClass]="notificationType"
     [@fadeInOut]>
  {{ notificationMessage }}
</div>